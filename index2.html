<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>××©×—×§ ××™×•×ª ×œ×™×œ×“×™× (×ª××•× ×•×ª ×ª×•×××•×ª ×™×•×ª×¨)</title>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <style>
    :root{
      --bg1:#0f172a; --bg2:#111827; --card:#0b1224cc; --text:#e5e7eb; --muted:#9ca3af;
      --accent:#22c55e; --danger:#ef4444; --warn:#facc15; --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 22px; --gap: 14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      background: radial-gradient(1200px 900px at 70% 10%, #1d4ed8 0%, transparent 55%),
                  radial-gradient(900px 900px at 20% 30%, #9333ea 0%, transparent 50%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      color:var(--text);
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding: 18px 14px 22px;
    }
    .app{ width:min(760px, 100%); display:flex; flex-direction:column; gap: var(--gap); }

    header{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; padding: 10px 6px 0; }
    .title{ display:flex; flex-direction:column; gap:6px; }
    .title h1{ margin:0; font-size: 18px; letter-spacing:.2px; }
    .title small{ color:var(--muted); font-size: 12px; }
    .modeRow{ display:flex; gap:8px; flex-wrap:wrap; }

    .pill{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(17,24,39,.55);
      color: var(--text);
      padding: 9px 11px;
      border-radius: 999px;
      box-shadow: 0 6px 16px rgba(0,0,0,.22);
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:800;
      font-size: 12px;
      white-space:nowrap;
    }
    .pill:active{ transform: translateY(1px); }
    .pill .dot{ width:10px;height:10px;border-radius:999px;background:var(--danger); box-shadow: 0 0 0 3px rgba(239,68,68,.15); }
    .pill.on .dot{ background:var(--accent); box-shadow: 0 0 0 3px rgba(34,197,94,.15); }

    .chip{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(17,24,39,.45);
      color: rgba(255,255,255,.9);
      padding: 9px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:900;
      font-size: 12px;
      user-select:none;
    }
    .chip.active{
      background: rgba(34,197,94,.18);
      border-color: rgba(34,197,94,.35);
    }

    .card{
      background: var(--card);
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      overflow:hidden;
    }

    .imageWrap{
      position:relative;
      border-radius: 18px;
      overflow:hidden;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      aspect-ratio: 4 / 3;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    img#itemImage{
      width:100%;
      height:100%;
      object-fit: cover;
      transform: scale(1.6);
      transition: transform 420ms ease, opacity 180ms ease;
      opacity: 0.001;
    }
    .imgReady img#itemImage{ opacity: 1; }
    .revealed img#itemImage{ transform: scale(1.0); }

    .loaderOverlay{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.28);
      backdrop-filter: blur(2px);
      z-index: 5;
    }
    .loaderOverlay.on{ display:flex; }
    .spinner{
      width: 44px; height: 44px;
      border-radius: 999px;
      border: 4px solid rgba(255,255,255,.18);
      border-top-color: rgba(255,255,255,.88);
      animation: spin 1s linear infinite;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }
    .loadingText{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(255,255,255,.85);
      text-align:center;
      font-weight:1000;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .overlayTag{
      position:absolute;
      inset: auto 12px 12px 12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      pointer-events:none;
      flex-wrap:wrap;
      z-index: 6;
    }
    .badge{
      background: rgba(0,0,0,.38);
      border:1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(6px);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: rgba(255,255,255,.9);
      white-space:nowrap;
    }

    .message{
      padding: 12px 14px;
      border-radius: 18px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(17,24,39,.38);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .message .left{ display:flex; flex-direction:column; gap:3px; }
    .message .left b{ font-size: 14px; }
    .message .left span{ font-size: 12px; color: var(--muted); }
    .message .right{ font-size: 12px; color: rgba(255,255,255,.85); white-space:nowrap; }

    .hintRow{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
    }
    .hintBtn{
      height: 44px;
      padding: 0 14px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      font-weight:1000;
      cursor:pointer;
      user-select:none;
    }
    .hintBtn:active{ transform: translateY(1px); }

    .slots{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; padding: 10px 4px 2px; }
    .slot{
      width: 54px; height: 56px; border-radius: 16px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.14);
      display:flex; align-items:center; justify-content:center;
      font-size: 28px; font-weight: 1000;
      user-select:none; cursor:pointer;
      transition: background .2s ease, border-color .2s ease, color .2s ease;
    }
    .slot.filled{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.18); }
    .slot.correct{ background: rgba(34,197,94,.20); border-color: rgba(34,197,94,.55); }
    .slot.present{ background: rgba(250,204,21,.18); border-color: rgba(250,204,21,.55); }
    .slot.absent{ background: rgba(148,163,184,.10); border-color: rgba(148,163,184,.25); color: rgba(255,255,255,.78); }

    .bank{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; padding: 10px 2px 2px; }
    .letterBtn{
      min-width: 56px; height: 56px; padding: 0 12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(31,41,55,.85), rgba(17,24,39,.85));
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      color: var(--text);
      font-size: 24px; font-weight: 1000;
      cursor:pointer; user-select:none;
      position:relative;
    }
    .letterBtn:active{ transform: translateY(1px); }
    .letterBtn.hint{
      background: rgba(250,204,21,.18);
      border-color: rgba(250,204,21,.55);
    }
    .countBubble{
      position:absolute;
      left:8px; top:8px;
      width:20px; height:20px;
      border-radius:999px;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);
      display:flex; align-items:center; justify-content:center;
      font-size: 12px;
      font-weight: 1000;
      color: rgba(255,255,255,.9);
      pointer-events:none;
    }

    .footerRow{ display:flex; gap:10px; justify-content:space-between; align-items:center; flex-wrap:wrap; margin-top: 10px; }
    .btn{
      flex:1; min-width: 140px; height: 54px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(17,24,39,.65);
      color: var(--text);
      font-weight: 1000;
      cursor:pointer;
      box-shadow: 0 10px 24px rgba(0,0,0,.20);
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(180deg, rgba(34,197,94,.95), rgba(16,185,129,.85));
      border-color: rgba(34,197,94,.55);
      color: #052e16;
    }
    .btn.ghost{ background: rgba(255,255,255,.06); }

    .startOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.45);
      display:flex; align-items:center; justify-content:center;
      padding: 18px; z-index: 50;
    }
    .startCard{
      width:min(620px, 100%);
      border-radius: 26px;
      padding: 18px;
      background: rgba(3,7,18,.75);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 24px 60px rgba(0,0,0,.45);
      text-align:center;
    }
    .startCard h2{margin:6px 0 8px;font-size:20px}
    .startCard p{margin:0 0 14px;color:var(--muted);font-size:13px;line-height:1.45}
    .startCard .big{ width:100%; height: 56px; border-radius: 18px; font-size: 16px; }

    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.75);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 60;
      padding: 18px;
    }
    .modal.open{ display:flex; }
    .modalBox{
      width:min(900px, 100%);
      background: rgba(3,7,18,.85);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 20px;
      overflow:hidden;
      box-shadow: 0 24px 60px rgba(0,0,0,.5);
    }
    .modalTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .modalTop b{ font-size: 14px; }
    .modalTop button{
      height: 38px;
      padding: 0 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.9);
      font-weight:1000;
      cursor:pointer;
    }
    .modalImg{
      width:100%;
      display:block;
      max-height: 80vh;
      object-fit: contain;
      background: rgba(0,0,0,.25);
    }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div class="title">
        <h1>××©×—×§ ××™×•×ª â€“ ××” ×‘×ª××•× ×”?</h1>
        <small>×“×™×•×§ ×’×‘×•×” ×™×•×ª×¨: ×ª××•× ×•×ª ×œ×¤×™ â€œdepicts (P180)â€ ×‘Ö¾Wikimedia Commons</small>

        <div class="modeRow">
          <div class="chip active" data-mode="all">×”×›×œ</div>
          <div class="chip" data-mode="living">×—×™</div>
          <div class="chip" data-mode="plant">×¦×•××—</div>
          <div class="chip" data-mode="inanimate">×“×•××</div>
        </div>
      </div>

      <div class="controls">
        <div id="soundToggle" class="pill on" role="button" aria-label="×”×¤×¢×œ×ª ×¦×œ×™×œ">
          <span class="dot" aria-hidden="true"></span>
          <span>×¦×œ×™×œ</span>
        </div>
      </div>
    </header>

    <section class="card">
      <div id="imageBox" class="imageWrap">
        <img id="itemImage" alt="×ª××•× ×” ×¨× ×“×•××œ×™×ª" />
        <div class="loaderOverlay" id="loader">
          <div style="display:flex;flex-direction:column;align-items:center;">
            <div class="spinner"></div>
            <div class="loadingText" id="loaderText">×˜×•×¢×Ÿ ×ª××•× ×”â€¦</div>
          </div>
        </div>

        <div class="overlayTag">
          <div class="badge" id="levelBadge">×¡×‘×‘ 1</div>
          <div class="badge" id="typeBadge">×¡×•×’: ×”×›×œ</div>
          <div class="badge" id="hintBadge">×¨××–: â€¦</div>
          <div class="badge" id="prefetchBadge">××›×™×Ÿ ×”×‘×â€¦</div>
        </div>
      </div>

      <div class="hintRow">
        <button class="hintBtn" id="hintZoomBtn">×¨××–: ×”×’×“×œ ×ª××•× ×”</button>
        <button class="hintBtn" id="hintLettersBtn">×¨××–: ××•×ª×™×•×ª</button>
        <button class="hintBtn" id="hintGiveBtn">×¨××–: ×ª×Ÿ ×œ×™ ××•×ª</button>
      </div>
    </section>

    <section class="card">
      <div class="message">
        <div class="left">
          <b id="statusTitle">×‘×•×/×™ × × ×—×©!</b>
          <span id="statusSub">×‘×—×¨/×™ ××•×ª×™×•×ª ××”××—×¡×Ÿ ×•××– ×œ×—×¥/×™ ×‘×“×•×§</span>
        </div>
        <div class="right" id="progressText">0 / 0</div>
      </div>

      <div class="slots" id="slots"></div>
      <div style="height:1px;background:rgba(255,255,255,.08);margin:6px 0 2px;"></div>
      <div class="bank" id="bank"></div>

      <div class="footerRow">
        <button class="btn ghost" id="clearBtn">× ×§×”</button>
        <button class="btn primary" id="checkBtn">×‘×“×•×§</button>
        <button class="btn" id="nextBtn">×œ×ª××•× ×” ×”×‘××”</button>
      </div>
    </section>
  </div>

  <div class="modal" id="imgModal" role="dialog" aria-modal="true">
    <div class="modalBox">
      <div class="modalTop">
        <b id="modalTitle">×ª××•× ×” ××œ××”</b>
        <button id="modalClose">×¡×’×•×¨</button>
      </div>
      <img id="modalImg" class="modalImg" alt="×ª××•× ×” ××œ××”" />
    </div>
  </div>

  <div class="startOverlay" id="startOverlay">
    <div class="startCard">
      <h2>××•×›× ×™× ×œ×©×—×§? ğŸˆ</h2>
      <p>×‘×›×œ ×¡×‘×‘: ×‘×•×—×¨×™× ××™×œ×” ×§×œ×”, ×•××‘×™××™× ×ª××•× ×” ××”××™× ×˜×¨× ×˜ ×©××¡×•×× ×ª â€œ××” ×™×© ×‘×ª××•× ×”â€.</p>
      <button class="btn primary big" id="startBtn">×”×ª×—×œ</button>
    </div>
  </div>

<script>
(() => {
  // ===== DOM =====
  const img = document.getElementById("itemImage");
  const imageBox = document.getElementById("imageBox");
  const slotsEl = document.getElementById("slots");
  const bankEl = document.getElementById("bank");
  const statusTitle = document.getElementById("statusTitle");
  const statusSub = document.getElementById("statusSub");
  const progressText = document.getElementById("progressText");
  const levelBadge = document.getElementById("levelBadge");
  const hintBadge = document.getElementById("hintBadge");
  const prefetchBadge = document.getElementById("prefetchBadge");
  const typeBadge = document.getElementById("typeBadge");

  const clearBtn = document.getElementById("clearBtn");
  const checkBtn = document.getElementById("checkBtn");
  const nextBtn = document.getElementById("nextBtn");
  const startOverlay = document.getElementById("startOverlay");
  const startBtn = document.getElementById("startBtn");
  const soundToggle = document.getElementById("soundToggle");
  const modeChips = Array.from(document.querySelectorAll(".chip"));

  const hintZoomBtn = document.getElementById("hintZoomBtn");
  const hintLettersBtn = document.getElementById("hintLettersBtn");
  const hintGiveBtn = document.getElementById("hintGiveBtn");

  const imgModal = document.getElementById("imgModal");
  const modalImg = document.getElementById("modalImg");
  const modalClose = document.getElementById("modalClose");
  const modalTitle = document.getElementById("modalTitle");

  const loader = document.getElementById("loader");
  const loaderText = document.getElementById("loaderText");

  // ===== State =====
  let round = 0;
  let mode = "all";
  let current = null; // {he, kind, qid, img}
  let targetLetters = [];
  let answer = [];
  let bankCounts = new Map();
  let feedback = [];
  let solved = false;
  let hintHighlighted = false;

  // Prefetch
  let nextPromise = null;
  let nextReady = null;
  let prefetchInFlight = false;

  // ===== Easy words + QIDs (×¨×§ ××–×”×™×, ×œ× ×ª××•× ×•×ª) =====
  // ×–×” ××” ×©××©×¤×¨ ×”×ª×××”: ×× ×—× ×• ××—×¤×©×™× ×§×‘×¦×™× ×‘Ö¾Commons ×¢× depicts=P180=QID
  const WORDS = {
    living: [
      {he:"×›×œ×‘", qid:"Q144"},
      {he:"×—×ª×•×œ", qid:"Q146"},
      {he:"×¡×•×¡", qid:"Q726"},
      {he:"×¤×¨×”", qid:"Q830"},
      {he:"×›×‘×©×”", qid:"Q7368"},
      {he:"×“×‘×•×¨×”", qid:"Q12913"},
      {he:"××¨× ×‘", qid:"Q9394"},
      {he:"×¦×™×¤×•×¨", qid:"Q5113"},
    ],
    plant: [
      {he:"×¤×¨×—", qid:"Q506"},
      {he:"×¢×œ×”", qid:"Q33971"},
      {he:"×¢×¥", qid:"Q10884"},
      {he:"×“×©×", qid:"Q27302"},
      {he:"×‘× × ×”", qid:"Q503"},
      {he:"×ª×¤×•×—", qid:"Q89"},
      {he:"×¢× ×‘", qid:"Q10978"},
      {he:"×œ×™××•×Ÿ", qid:"Q10998"},
    ],
    inanimate: [
      {he:"×›×•×¡", qid:"Q81727"},
      {he:"×¡×¤×¨", qid:"Q571"},
      {he:"×›×“×•×¨", qid:"Q7411"},
      {he:"××¤×ª×—", qid:"Q14467"},
      {he:"×›×™×¡×", qid:"Q15026"},
      {he:"×©×•×œ×—×Ÿ", qid:"Q14745"},
      {he:"×˜×œ×¤×•×Ÿ", qid:"Q11035"},
      {he:"×¢×™×¤×¨×•×Ÿ", qid:"Q14674"},
      {he:"× ×¨", qid:"Q13133"},
      {he:"×—×•×œ×¦×”", qid:"Q17132"},
    ]
  };

  const HEB_LETTERS = "××‘×’×“×”×•×–×—×˜×™×›×œ×× ×¡×¢×¤×¦×§×¨×©×ª".split("");

  // ===== Helpers =====
  function modeLabel(m){ return m==="living"?"×—×™":m==="plant"?"×¦×•××—":m==="inanimate"?"×“×•××":"×”×›×œ"; }
  function shuffle(arr){ const a=arr.slice(); for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }
  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

  function showLoader(on, text="×˜×•×¢×Ÿ ×ª××•× ×”â€¦"){
    loaderText.textContent = text;
    loader.classList.toggle("on", on);
    if (on) imageBox.classList.remove("imgReady");
  }
  function setStatus(t,s){ statusTitle.textContent=t; statusSub.textContent=s; }
  function updateProgress(){
    const filled = answer.filter(Boolean).length;
    progressText.textContent = `${filled} / ${answer.length}`;
  }
  function setPrefetchBadge(state){
    if (state==="loading"){ prefetchBadge.textContent="××›×™×Ÿ ×”×‘×â€¦"; prefetchBadge.style.opacity="0.95"; }
    else if (state==="ready"){ prefetchBadge.textContent="×”×‘× ××•×›×Ÿ âœ…"; prefetchBadge.style.opacity="0.95"; }
    else if (state==="error"){ prefetchBadge.textContent="×‘×¢×™×” ×‘×”×‘× âš ï¸"; prefetchBadge.style.opacity="0.95"; }
    else { prefetchBadge.textContent=""; prefetchBadge.style.opacity="0"; }
  }

  function pickWord(){
    if (mode==="living") return {...WORDS.living[Math.floor(Math.random()*WORDS.living.length)], kind:"living"};
    if (mode==="plant") return {...WORDS.plant[Math.floor(Math.random()*WORDS.plant.length)], kind:"plant"};
    if (mode==="inanimate") return {...WORDS.inanimate[Math.floor(Math.random()*WORDS.inanimate.length)], kind:"inanimate"};
    const groups = ["living","plant","inanimate"];
    const g = groups[Math.floor(Math.random()*groups.length)];
    return {...WORDS[g][Math.floor(Math.random()*WORDS[g].length)], kind:g};
  }

  // ===== Music (simple) =====
  let audioCtx=null, soundOn=true, bgTimer=null, bgMode="play";
  function ensureAudio(){ if(!audioCtx){ const Ctx=window.AudioContext||window.webkitAudioContext; audioCtx=new Ctx(); } }
  function playTone({freq=440,dur=0.12,type="sine",gain=0.06,when=0}){
    if(!audioCtx||!soundOn) return;
    const t0=audioCtx.currentTime+when;
    const osc=audioCtx.createOscillator();
    const g=audioCtx.createGain();
    osc.type=type; osc.frequency.setValueAtTime(freq,t0);
    g.gain.setValueAtTime(0.0001,t0);
    g.gain.exponentialRampToValueAtTime(gain,t0+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001,t0+dur);
    osc.connect(g); g.connect(audioCtx.destination);
    osc.start(t0); osc.stop(t0+dur+0.02);
  }
  function stopBg(){ if(bgTimer){ clearInterval(bgTimer); bgTimer=null; } }
  function startPlayMusic(){
    if(!audioCtx||!soundOn) return;
    stopBg(); bgMode="play";
    const base=220, scale=[1,6/5,3/2,8/5,2];
    let step=0;
    bgTimer=setInterval(()=>{
      if(!soundOn||bgMode!=="play") return;
      const f=base*scale[step%scale.length];
      playTone({freq:f,dur:0.11,type:"triangle",gain:0.04});
      step++;
    },260);
  }
  function startLoadingMusic(){
    if(!audioCtx||!soundOn) return;
    stopBg(); bgMode="load";
    let step=0;
    bgTimer=setInterval(()=>{
      if(!soundOn||bgMode!=="load") return;
      const f=420+(step%3)*70;
      playTone({freq:f,dur:0.06,type:"square",gain:0.03});
      step++;
    },180);
  }
  function setMusicLoading(on){
    if(!audioCtx||!soundOn) return;
    if(on) startLoadingMusic(); else startPlayMusic();
  }
  function playSuccess(){
    if(!audioCtx||!soundOn) return;
    playTone({freq:523.25,dur:0.10,gain:0.08,when:0.00});
    playTone({freq:659.25,dur:0.10,gain:0.08,when:0.11});
    playTone({freq:783.99,dur:0.14,gain:0.09,when:0.22});
  }
  function setSound(on){
    soundOn=on;
    soundToggle.classList.toggle("on",on);
    if(!on) stopBg();
    else if(audioCtx) startPlayMusic();
  }
  soundToggle.addEventListener("click",()=>setSound(!soundOn));

  // ===== Better image fetch: Commons search by depicts (P180=QID) =====
  function isBadTitle(t){
    const s=(t||"").toLowerCase();
    if (s.includes(".svg")) return true;
    const bad = ["icon","logo","flag","coat of arms","map","symbol","pictogram","emoji","diagram"];
    return bad.some(w => s.includes(w));
  }

  async function fetchCommonsImageByDepicts(qid){
    // Commons search: files that have structured data: depicts (P180) equals the QID
    // plus try to prefer bitmap-like results; still we filter .svg by title
    const search =
      `haswbstatement:P180=${qid} -filetype:svg -insource:"svg"`;

    const url =
      "https://commons.wikimedia.org/w/api.php" +
      "?action=query&format=json&origin=*" +
      "&generator=search" +
      "&gsrnamespace=6" +
      "&gsrlimit=25" +
      "&gsrsearch=" + encodeURIComponent(search) +
      "&prop=imageinfo" +
      "&iiprop=url" +
      "&iiurlwidth=900";

    const res = await fetch(url);
    if(!res.ok) throw new Error("commons depicts search failed: " + res.status);
    const data = await res.json();
    const pages = data?.query?.pages;
    if(!pages) throw new Error("no pages");

    const list = Object.values(pages)
      .map(p => ({
        title: p?.title || "",
        url: p?.imageinfo?.[0]?.thumburl || p?.imageinfo?.[0]?.url || ""
      }))
      .filter(x => x.url && !isBadTitle(x.title));

    if(!list.length) throw new Error("no good images for qid");
    const pick = list[Math.floor(Math.random()*list.length)];
    return pick.url;
  }

  // fallback: if depicts isn't available for that term (some items have few structured tags)
  async function fetchCommonsImageByText(term){
    const url =
      "https://commons.wikimedia.org/w/api.php" +
      "?action=query&format=json&origin=*" +
      "&generator=search" +
      "&gsrnamespace=6" +
      "&gsrlimit=25" +
      "&gsrsearch=" + encodeURIComponent(term + " -filetype:svg") +
      "&prop=imageinfo" +
      "&iiprop=url" +
      "&iiurlwidth=900";

    const res = await fetch(url);
    if(!res.ok) throw new Error("commons text search failed: " + res.status);
    const data = await res.json();
    const pages = data?.query?.pages;
    if(!pages) throw new Error("no pages");

    const list = Object.values(pages)
      .map(p => ({
        title: p?.title || "",
        url: p?.imageinfo?.[0]?.thumburl || p?.imageinfo?.[0]?.url || ""
      }))
      .filter(x => x.url && !isBadTitle(x.title));

    if(!list.length) throw new Error("no good images for term");
    const pick = list[Math.floor(Math.random()*list.length)];
    return pick.url;
  }

  async function fetchItemWithBetterMatch(){
    // we try several times; each time pick a new word and get a depicts-based image
    for(let tries=0; tries<10; tries++){
      const w = pickWord();
      try{
        const imgUrl = await fetchCommonsImageByDepicts(w.qid);
        return { ...w, img: imgUrl };
      }catch{
        // fallback for this word: try text-based once
        try{
          const imgUrl = await fetchCommonsImageByText(w.he);
          return { ...w, img: imgUrl };
        }catch{
          await sleep(120 + Math.random()*200);
        }
      }
    }
    // last resort: still let user skip
    return { he:"×›×•×¡", kind:"inanimate", qid:"Q81727", img: placeholderDataUrl() };
  }

  function placeholderDataUrl(){
    const svg =
      `<svg xmlns="http://www.w3.org/2000/svg" width="900" height="700">
        <rect width="100%" height="100%" fill="#111827"/>
        <text x="50%" y="46%" text-anchor="middle" font-size="44" fill="white" font-family="Arial">××™×Ÿ ×ª××•× ×” ×›×¨×’×¢</text>
        <text x="50%" y="56%" text-anchor="middle" font-size="28" fill="rgba(255,255,255,.8)" font-family="Arial">×œ×—×¦×• â€œ×œ×ª××•× ×” ×”×‘××”â€</text>
      </svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
  }

  async function loadImageWithTimeout(url, maxWaitMs=6500){
    return await new Promise((resolve)=>{
      let done=false;
      const onLoad=()=>{ if(done) return; done=true; cleanup(); resolve(true); };
      const onErr =()=>{ if(done) return; done=true; cleanup(); resolve(false); };
      const cleanup=()=>{
        img.removeEventListener("load", onLoad);
        img.removeEventListener("error", onErr);
      };
      img.addEventListener("load", onLoad);
      img.addEventListener("error", onErr);
      img.referrerPolicy = "no-referrer";
      img.src = url;
      setTimeout(()=>{ if(done) return; done=true; cleanup(); resolve(false); }, maxWaitMs);
    });
  }

  // ===== Wordle feedback =====
  function computeFeedback(guessLetters, targetLettersArr){
    const n=targetLettersArr.length;
    const result=new Array(n).fill("absent");
    const remaining=new Map();

    for(let i=0;i<n;i++){
      if(guessLetters[i]===targetLettersArr[i]) result[i]="correct";
      else remaining.set(targetLettersArr[i], (remaining.get(targetLettersArr[i])||0)+1);
    }
    for(let i=0;i<n;i++){
      if(result[i]==="correct") continue;
      const g=guessLetters[i];
      const cnt=remaining.get(g)||0;
      if(cnt>0){ result[i]="present"; remaining.set(g,cnt-1); }
    }
    return result;
  }

  // ===== Bank with counts =====
  function buildBankCounts(wordLetters){
    const counts=new Map();
    for(const ch of wordLetters) counts.set(ch,(counts.get(ch)||0)+1);

    const maxButtons=10;
    const existingTypes=counts.size;
    const wantExtraTypes=Math.max(0, Math.min(maxButtons-existingTypes, 4+Math.floor(Math.random()*3)));
    let added=0;
    while(added<wantExtraTypes){
      const l=HEB_LETTERS[Math.floor(Math.random()*HEB_LETTERS.length)];
      if(counts.has(l)) continue;
      counts.set(l,1);
      added++;
    }
    return counts;
  }

  // ===== Prefetch =====
  function startPrefetchIfNeeded(){
    if(prefetchInFlight || nextReady){
      if(nextReady) setPrefetchBadge("ready");
      return;
    }
    prefetchInFlight=true;
    setPrefetchBadge("loading");
    nextPromise=(async()=>{
      const item=await fetchItemWithBetterMatch();
      const im=new Image();
      im.referrerPolicy="no-referrer";
      im.src=item.img;
      return item;
    })();
    nextPromise.then(item=>{
      nextReady=item;
      setPrefetchBadge("ready");
    }).catch(()=>setPrefetchBadge("error"))
      .finally(()=>{ prefetchInFlight=false; });
  }

  async function consumePrefetchedOrFetch(){
    if(nextReady){
      const item=nextReady;
      nextReady=null; nextPromise=null;
      setPrefetchBadge("loading");
      return item;
    }
    if(nextPromise){
      const item=await nextPromise;
      nextPromise=null; nextReady=null;
      return item;
    }
    setPrefetchBadge("loading");
    return await fetchItemWithBetterMatch();
  }

  // ===== Rendering =====
  function renderSlots(){
    slotsEl.innerHTML="";
    answer.forEach((ch,idx)=>{
      const div=document.createElement("div");
      const fb=feedback[idx]||"";
      div.className="slot"+(ch?" filled":"")+(fb?" "+fb:"");
      div.textContent=ch||"";
      div.addEventListener("click",()=>{
        if(solved) return;
        if(!answer[idx]) return;
        const letter=answer[idx];
        answer[idx]="";
        feedback[idx]="";
        bankCounts.set(letter,(bankCounts.get(letter)||0)+1);
        renderAll();
        setStatus("×©×™× ×•×™×™×","××¤×©×¨ ×œ×”××©×™×š ×•××– ×œ×œ×—×•×¥ ×‘×“×•×§");
      });
      slotsEl.appendChild(div);
    });
    updateProgress();
  }

  function renderBank(){
    bankEl.innerHTML="";
    const entries=shuffle(Array.from(bankCounts.entries()).filter(([_,c])=>c>0));
    for(const [ch,count] of entries){
      const btn=document.createElement("button");
      btn.className="letterBtn";
      btn.type="button";
      btn.textContent=ch;

      if(hintHighlighted && targetLetters.includes(ch)) btn.classList.add("hint");

      if(count>1){
        const bubble=document.createElement("div");
        bubble.className="countBubble";
        bubble.textContent=String(count);
        btn.appendChild(bubble);
      }

      btn.addEventListener("click",()=>{
        if(solved) return;
        const slotIndex=answer.findIndex(x=>!x);
        if(slotIndex===-1) return;
        bankCounts.set(ch, count-1);
        answer[slotIndex]=ch;
        feedback[slotIndex]="";
        renderAll();
      });
      bankEl.appendChild(btn);
    }
  }

  function renderAll(){ renderSlots(); renderBank(); }

  function onSuccess(){
    if(solved) return;
    solved=true;
    setStatus("×›×œ ×”×›×‘×•×“! ğŸ‰","×”×¦×œ×—×ª!");
    imageBox.classList.add("revealed");
    try{
      confetti({ particleCount: 140, spread: 70, origin: { y: 0.7 } });
      setTimeout(()=>confetti({ particleCount: 80, spread: 55, origin: { y: 0.65 } }),180);
    }catch{}
    playSuccess();
    startPrefetchIfNeeded();
  }

  // ===== Hints =====
  function openModal(){
    modalTitle.textContent=`×ª××•× ×” ××œ××” (${modeLabel(current?.kind||mode)})`;
    modalImg.referrerPolicy="no-referrer";
    modalImg.src=img.src;
    imgModal.classList.add("open");
  }
  function closeModal(){ imgModal.classList.remove("open"); }
  modalClose.addEventListener("click", closeModal);
  imgModal.addEventListener("click",(e)=>{ if(e.target===imgModal) closeModal(); });

  hintZoomBtn.addEventListener("click",()=>{ if(current) openModal(); });

  hintLettersBtn.addEventListener("click",()=>{
    if(!current) return;
    hintHighlighted=!hintHighlighted;
    renderBank();
    setStatus("×¨××– ××•×ª×™×•×ª", hintHighlighted ? "×¡×™×× ×• ×‘××—×¡×Ÿ ××ª ×”××•×ª×™×•×ª ×©×¦×¨×™×š (×‘×¦×”×•×‘)" : "×›×™×‘×™× ×• ××ª ×”×¡×™××•×Ÿ");
  });

  hintGiveBtn.addEventListener("click",()=>{
    if(!current||solved) return;
    for(let i=0;i<targetLetters.length;i++){
      if(answer[i]) continue;
      const needed=targetLetters[i];
      const cnt=bankCounts.get(needed)||0;
      if(cnt>0){
        bankCounts.set(needed,cnt-1);
        answer[i]=needed;
        feedback[i]="";
        renderAll();
        setStatus("×¨××–: ×§×™×‘×œ×ª ××•×ª!","×©×× ×• ××•×ª ××—×ª ×‘××§×•× ×”× ×›×•×Ÿ ğŸ™‚");
        return;
      }
    }
    setStatus("×¨××–: ××™ ××¤×©×¨ ×›×¨×’×¢","××¤×©×¨ ×œ×”×—×–×™×¨ ××•×ª×™×•×ª ××”×ª×©×•×‘×” ×œ××—×¡×Ÿ ×‘×œ×—×™×¦×” ×¢×œ ××©×‘×¦×ª.");
  });

  // ===== Buttons =====
  checkBtn.addEventListener("click",()=>{
    if(solved) return;
    const guess=answer.join("");
    if(guess.length < targetLetters.length){
      setStatus("×¢×•×“ ×§×¦×ª ğŸ™‚","××œ×/×™ ××ª ×›×œ ×”××•×ª×™×•×ª ×•××– × ×‘×“×•×§!");
      return;
    }
    feedback=computeFeedback(answer.slice(), targetLetters.slice());
    renderSlots();
    if(guess === current.he) onSuccess();
    else setStatus("×›××¢×˜! ğŸ˜„","×™×¨×•×§ = ×‘××§×•× ×”× ×›×•×Ÿ, ×¦×”×•×‘ = ××•×ª × ×›×•× ×” ×‘××§×•× ××—×¨");
  });

  clearBtn.addEventListener("click",()=>{
    if(solved) return;
    for(let i=0;i<answer.length;i++){
      if(!answer[i]) continue;
      const ch=answer[i];
      bankCounts.set(ch,(bankCounts.get(ch)||0)+1);
      answer[i]="";
      feedback[i]="";
    }
    renderAll();
    setStatus("× ×™×§×™× ×•!","×‘×•×/×™ × × ×¡×” ×©×•×‘ ğŸ™‚");
  });

  // ×ª××™×“ ××¤×©×¨ ×œ×“×œ×’
  nextBtn.addEventListener("click",()=>newRound());

  // ===== Mode selection =====
  modeChips.forEach(ch=>{
    ch.addEventListener("click", async ()=>{
      const m=ch.getAttribute("data-mode");
      if(!m || m===mode) return;
      mode=m;
      modeChips.forEach(x=>x.classList.toggle("active", x===ch));
      typeBadge.textContent=`×¡×•×’: ${modeLabel(mode)}`;

      nextReady=null; nextPromise=null; prefetchInFlight=false;
      setPrefetchBadge("loading");

      await newRound();
    });
  });

  // ===== Round flow =====
  async function newRound(){
    solved=false;
    hintHighlighted=false;
    imageBox.classList.remove("revealed");

    round += 1;
    levelBadge.textContent=`×¡×‘×‘ ${round}`;
    typeBadge.textContent=`×¡×•×’: ${modeLabel(mode)}`;
    hintBadge.textContent="×¨××–: â€¦";
    setStatus("×˜×•×¢×Ÿâ€¦","×¨×’×¢ ×§×˜×Ÿ ğŸ™‚");

    showLoader(true, "××—×¤×© ×ª××•× ×” ×˜×•×‘×”â€¦");
    setMusicLoading(true);

    const item = await consumePrefetchedOrFetch();
    current = item;

    targetLetters = current.he.split("");
    answer = new Array(targetLetters.length).fill("");
    feedback = new Array(targetLetters.length).fill("");
    bankCounts = buildBankCounts(targetLetters);

    hintBadge.textContent = `×¨××–: ${targetLetters.length} ××•×ª×™×•×ª`;
    typeBadge.textContent = `×¡×•×’: ${modeLabel(current.kind)}`;

    // ×× ×”×ª××•× ×” ×œ× × ×˜×¢× ×ª â€” × ×‘×™× ×ª××•× ×” ××—×¨×ª ×œ××•×ª×” ××™×œ×” (×¢×“ 4 ×¤×¢××™×)
    let ok=false;
    for(let tries=0; tries<4; tries++){
      ok = await loadImageWithTimeout(current.img, 6500);
      if(ok) break;

      // × ×¡×” ×¢×•×“ ×ª××•× ×” (×¢×“×™×£ depicts; ×× ×œ×, ×˜×§×¡×˜)
      try{
        current.img = await fetchCommonsImageByDepicts(current.qid);
      }catch{
        try{ current.img = await fetchCommonsImageByText(current.he); } catch {}
      }
      await sleep(120);
    }

    showLoader(false);
    imageBox.classList.add("imgReady");
    setMusicLoading(false);

    if(!ok){
      img.src = placeholderDataUrl();
      setStatus("×œ× ×”×¦×œ×—×ª×™ ×œ×˜×¢×•×Ÿ ×ª××•× ×”","×œ×—×¥/×™ â€œ×œ×ª××•× ×” ×”×‘××”â€ ×›×“×™ ×œ×“×œ×’");
    }else{
      setStatus("×‘×•×/×™ × × ×—×©!","×‘×—×¨/×™ ××•×ª×™×•×ª ××”××—×¡×Ÿ ×•××– ×œ×—×¥/×™ ×‘×“×•×§");
    }

    renderAll();
    startPrefetchIfNeeded();
  }

  // ===== Start =====
  startBtn.addEventListener("click", async ()=>{
    startOverlay.style.display="none";
    ensureAudio();
    try{ await audioCtx.resume(); }catch{}
    if(soundOn) startPlayMusic();
    setPrefetchBadge("loading");
    startPrefetchIfNeeded();
    newRound();
  });

  setPrefetchBadge("idle");
})();
</script>
</body>
</html>
